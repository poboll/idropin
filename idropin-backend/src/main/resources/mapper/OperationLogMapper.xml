<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.idropin.infrastructure.persistence.mapper.OperationLogMapper">

    <resultMap id="OperationLogVOResultMap" type="com.idropin.domain.vo.OperationLogVO">
        <id property="id" column="id"/>
        <result property="operatorId" column="operator_id"/>
        <result property="operatorName" column="operator_name"/>
        <result property="operationType" column="operation_type"/>
        <result property="targetType" column="target_type"/>
        <result property="targetId" column="target_id"/>
        <result property="description" column="description"/>
        <result property="ipAddress" column="ip_address"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="selectLogPage" resultMap="OperationLogVOResultMap">
        SELECT 
            l.id,
            l.operator_id,
            COALESCE(u.username, '系统') as operator_name,
            l.operation_type,
            l.target_type,
            l.target_id,
            l.description,
            l.ip_address,
            l.created_at
        FROM sys_operation_log l
        LEFT JOIN sys_user u ON l.operator_id = u.id
        ORDER BY l.created_at DESC
    </select>

    <select id="countLogs" resultType="java.lang.Long">
        SELECT COUNT(*) FROM sys_operation_log
    </select>

    <select id="countLogsYesterday" resultType="java.lang.Long">
        SELECT COUNT(*) FROM sys_operation_log 
        WHERE created_at >= CURRENT_DATE - INTERVAL '1 day' 
        AND created_at &lt; CURRENT_DATE
    </select>

</mapper>
