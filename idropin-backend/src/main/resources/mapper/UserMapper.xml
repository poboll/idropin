<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.idropin.infrastructure.persistence.mapper.UserMapper">

    <resultMap id="AdminUserVOResultMap" type="com.idropin.domain.vo.AdminUserVO">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="status" column="status"/>
        <result property="role" column="role"/>
        <result property="storageUsed" column="storage_used"/>
        <result property="storageLimit" column="storage_limit"/>
        <result property="taskCount" column="task_count"/>
        <result property="taskLimit" column="task_limit"/>
        <result property="createdAt" column="created_at"/>
        <result property="lastLoginAt" column="last_login_at"/>
        <result property="lastLoginIp" column="last_login_ip"/>
    </resultMap>

    <select id="selectAdminUserPage" resultMap="AdminUserVOResultMap">
        SELECT 
            u.id,
            u.username,
            u.email,
            u.phone,
            u.status,
            COALESCE(u.role, 'USER') as role,
            COALESCE(u.storage_used, 0) as storage_used,
            COALESCE(u.storage_limit, 10737418240) as storage_limit,
            (SELECT COUNT(*) FROM collection_task WHERE created_by = u.id) as task_count,
            COALESCE(u.task_limit, 100) as task_limit,
            u.created_at,
            u.last_login_at,
            u.last_login_ip
        FROM sys_user u
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (u.username LIKE CONCAT('%', #{keyword}, '%') 
                 OR u.email LIKE CONCAT('%', #{keyword}, '%')
                 OR u.phone LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="status != null and status != ''">
            AND u.status = #{status}
        </if>
        ORDER BY u.created_at DESC
    </select>

</mapper>
