<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.idropin.infrastructure.persistence.mapper.CollectionTaskMapper">

    <resultMap id="BaseResultMap" type="com.idropin.domain.entity.CollectionTask">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="deadline" property="deadline" jdbcType="TIMESTAMP"/>
        <result column="allow_anonymous" property="allowAnonymous" jdbcType="BOOLEAN"/>
        <result column="require_login" property="requireLogin" jdbcType="BOOLEAN"/>
        <result column="max_file_size" property="maxFileSize" jdbcType="BIGINT"/>
        <result column="allowed_types" property="allowedTypes" jdbcType="ARRAY" typeHandler="com.idropin.infrastructure.config.StringArrayTypeHandler"/>
        <result column="max_file_count" property="maxFileCount" jdbcType="INTEGER"/>
        <result column="created_by" property="createdBy" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="collection_type" property="collectionType" jdbcType="VARCHAR"/>
        <result column="deleted" property="deleted" jdbcType="BOOLEAN"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <select id="selectByIdString" resultMap="BaseResultMap">
        SELECT id, title, description, deadline, allow_anonymous, require_login, 
               max_file_size, allowed_types, max_file_count, created_by, status, collection_type, deleted, created_at, updated_at
        FROM collection_task
        WHERE id = CAST(#{id} AS VARCHAR)
    </select>

    <select id="selectByCreatedBy" resultMap="BaseResultMap">
        SELECT id, title, description, deadline, allow_anonymous, require_login, 
               max_file_size, allowed_types, max_file_count, created_by, status, collection_type, deleted, created_at, updated_at
        FROM collection_task
        WHERE CAST(created_by AS VARCHAR) = #{createdBy}
          AND (deleted = false OR deleted IS NULL)
        ORDER BY created_at DESC
    </select>

    <select id="selectDeletedByCreatedBy" resultMap="BaseResultMap">
        SELECT id, title, description, deadline, allow_anonymous, require_login,
               max_file_size, allowed_types, max_file_count, created_by, status, collection_type, deleted, created_at, updated_at
        FROM collection_task
        WHERE CAST(created_by AS VARCHAR) = #{createdBy}
          AND deleted = true
        ORDER BY updated_at DESC
    </select>

    <update id="softDeleteByIdAndCreatedBy">
        UPDATE collection_task
        SET deleted = true,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = CAST(#{id} AS VARCHAR)
          AND CAST(created_by AS VARCHAR) = #{createdBy}
          AND (deleted = false OR deleted IS NULL)
    </update>

    <update id="restoreByIdAndCreatedBy">
        UPDATE collection_task
        SET deleted = false,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = CAST(#{id} AS VARCHAR)
          AND CAST(created_by AS VARCHAR) = #{createdBy}
          AND deleted = true
    </update>

    <delete id="deletePermanentlyByIdAndCreatedBy">
        DELETE FROM collection_task
        WHERE id = CAST(#{id} AS VARCHAR)
          AND CAST(created_by AS VARCHAR) = #{createdBy}
          AND deleted = true
    </delete>

    <update id="updateByIdExplicit" parameterType="com.idropin.domain.entity.CollectionTask">
        UPDATE collection_task
        SET title           = #{title},
            description     = #{description},
            deadline        = #{deadline},
            allow_anonymous = #{allowAnonymous},
            require_login   = #{requireLogin},
            limit_one_per_device = #{limitOnePerDevice},
            max_file_size   = #{maxFileSize},
            allowed_types   = #{allowedTypes, jdbcType=ARRAY, typeHandler=com.idropin.infrastructure.config.StringArrayTypeHandler},
            max_file_count  = #{maxFileCount},
            status          = #{status},
            task_type       = #{taskType},
            collection_type = #{collectionType},
            updated_at      = #{updatedAt}
        WHERE id = CAST(#{id} AS VARCHAR)
          AND (deleted = false OR deleted IS NULL)
    </update>

    <insert id="insert" parameterType="com.idropin.domain.entity.CollectionTask">
        INSERT INTO collection_task (
            id,
            title,
            description,
            deadline,
            allow_anonymous,
            require_login,
            max_file_size,
            allowed_types,
            max_file_count,
            created_by,
            status,
            collection_type,
            created_at,
            updated_at
        ) VALUES (
            #{id},
            #{title},
            #{description},
            #{deadline},
            #{allowAnonymous},
            #{requireLogin},
            #{maxFileSize},
            #{allowedTypes, jdbcType=ARRAY, typeHandler=com.idropin.infrastructure.config.StringArrayTypeHandler},
            #{maxFileCount},
            #{createdBy},
            #{status},
            #{collectionType},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

</mapper>
